# 10-1 브라우저와 코드 공유

Node.js의 주요 관심 포인트 중 하나는 실제로 일부 브라우저(Google Chrome, Microsoft Edge)에서 구동하는 JavaScript 엔진인 V8이다.  
동일한 JavaScript 엔진을 공유하는 것만으로도 Node.js와 브라우저 간에 코드를 쉽게 공유할 수 있다고 생각할 수 있다.  
그러나 이 단순하고 독립적이면서 일반적인 일부의 코드만을 공유하려는 경우가 아닌 한, 항상 가능한 일은 아니다.

클라이언트와 서버 모두에 대한 코드를 개발하려면 동일한 코드가 본질적으로 다른 두 환경에서 제대로 실행될 수 있도록 하는데 무시할 수 없는 수준의 노력이 필요하다.  
Node.js에서는 DOM이나 수명이 긴 뷰(View)가 없지만, 브라우저에서는 기본적으로 운영체제와 상호작용할 파일 시스템 및 기타 인터페이스가 존재하지 않는다.

최신 JavaScript 기능에 대한 지원 수준에도 서로 다른 점이 있다.  
Node.js를 대상으로 한다면 서버에서 실행되는 Node.js의 버전을 알고있기 때문에 최신 언어 기능을 안전하게 채택할 수 있다.  
하지만 브라우저용 JavaScript 코드를 작성할 때는 동일한 확신을 가질 수 없다.  
이는 사용자마다 브라우저가 달라 최신 언어 기능과의 호환성 수준이 다르기 때문이다.  
일부 사용자는 async/await을 지원하는 최신 브라우저를 사용할 수도 있고, 지원하지 않는 구 버전의 브라우저를 사용할 수 도 있기 때문이다.

애플리케이션이 브라우저 호환 코드와 Node.js 코드간에 전환을 동적으로 또는 빌드 시에 할 수 있도록 하는 추상화, 패턴 및 도구들의 도움을 받아 수행할 수 있다.  
이 새로운 가능성에 대한 관심이 높아지면서 생태계의 많은 라이브러리와 프레임워크가 두 환경을 모두 지원하기 시작했다.  
Node.js에서 npm 패키지를 사용하는 경우 브라우저에서도 원활하게 작동할 가능성이 높다.  
그러나 이것이 브라우저와 Node.js 모두에서 문제없이 애플리케이션을 실행할 수 있다는 것을 보장하기에는 충분하지 않은 경우가 많다.  
그래서 크로스 플랫폼 코드를 개발할 때는 항상 신중한 디자인이 필요하다.

## 10-1-1 크로스 플랫폼 컨텍스트의 JavaScript 모듈

브라우저와 서버 간에 일부 코드를 공유하고 싶을 때 가장 먼저 부딪히는 장벽이 Node.js에서 사용하는 모듈 시스템과 브라우저에서 사용되는 모듈 시스템의 이기종 환경 간의 불일치이다.  
또 다른 문제는 브라우저에는 require() 함수나 모듈을 해결할 수 있는 파일 시스템이 없다는 것이다.  
대부분 최신 브라우저는 import 및 ES 모듈을 지원하지만 웹 사이트를 방문하는 일부 사용자는 이러한 최신 브라우저를 사용하지 않을 수도 있다.

이러한 문제 외에도 서버와 브라우저에 대한 코드 배포의 차이점도 고려해야 한다.  
서버에서 모듈은 파일 시스템에서 직접로드되는 데, 이것은 일반적으로 성능이 요구되는 작업이므로 개발자는 코드를 작은 모듈로 분할하여 서로 다른 로직 단위를 작고 체계적으로 유지하는 것이 좋다.

브라우저에서 스크립트를 적재하는 모델은 완전히 다르다.  
이 프로세스는 브라우저가 원격 엔드포인트에서 HTML 페이지를 다운로드하는 것으로 시작된다.  
HTML 코드는 브라우저에 의해 구문이 분석되어 다운로드 및 실행해야 하는 스크립트 파일에 대한 참조를 알아낸다.  
다운로드할 스크립트가 많을 수록 브라우저는 애플리케이션을 완전히 초기화하기 전에 상당수의 HTTP 요청을 발생시키고 여러 스크립트 파일을 다운로드하고 구문을 분석해야 한다.  
이는 스크립트 파일이 많을 수록 브라우저에서 애플리케이션을 실행하기 위해 지불해야 하는 성능 저하가 매우 클 수 있다.  
이러한 성능 저하의 일부는 **HTTP/2 Server Push**, 클라이언트 측의 캐싱, 사전로드 또는 유사한 기술을 채택하여 완하할 수 있지만 근본적인 문제는 여전히 존재한다.

이 문제를 해결하는 일반적인 방법은 브라우저용 패키지(또는 **번들**)를 “빌드”하는 것이다.  
일반적으로 빌드 프로세스는 모든 소스 파일을 매우 적은 수의 번들로 조합하여 브라우저가 각 페이지 방문에 대해 많은 수의 스크립트를 다운로드할 필요가 없도록 한다.  
빌드 프로세스는 파일 수를 줄이는 것 뿐만 아니라 최적화들을 수행할 수 있다.  
또 다른 일반적인 최적화는 코드 축소로, 기능을 변경하지 않고도 문자 수를 최소화할 수 있다.  
이것은 일반적으로 주석을 제거하고, 사용하지 않는 코드를 제거하고, 함수 및 변수 이름을 변경함으로써 수행된다.
